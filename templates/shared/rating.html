{% extends "base.html" %}

{% block content %}
<style>
/* Interactive and animated rating widget */
.rating-stars {
    display: inline-flex;
    flex-direction: row-reverse;
    justify-content: flex-end;
    gap: 3px;
}
.rating-stars input[type="radio"] {
    display: none;
}
.rating-stars label {
    color: #ccc;
    font-size: 1.6em;
    transition: color 0.20s, transform 0.15s;
    cursor: pointer;
    padding: 0;
}
.rating-stars label:hover,
.rating-stars label:hover ~ label {
    color: #ffc107;
    transform: scale(1.1) rotate(-3deg);
}
.rating-stars input[type="radio"]:checked ~ label {
    color: #ffc107;
    transform: scale(1.1) rotate(-3deg);
}
.rating-submit-anim {
    animation: btnBounce 0.4s;
}
@keyframes btnBounce {
    0% { transform: scale(1) translateY(0);}
    35% { transform: scale(1.15) translateY(-4px);}
    65% { transform: scale(0.98) translateY(2px);}
    100% { transform: scale(1) translateY(0);}
}
.fade-out-right {
    animation: fadeOutRight 0.7s forwards cubic-bezier(0.4,0,0.2,1);
}
@keyframes fadeOutRight {
    to {
        opacity: 0;
        transform: translateX(80px) scale(0.97);
        pointer-events: none;
    }
}
.fade-in {
    animation: fadeIn 0.7s;
}
@keyframes fadeIn {
    from { opacity:0; transform: translateY(20px);}
    to { opacity:1; transform: translateY(0);}
}

/* Hide carousel controls - only use skip button */
#tvmedia-rating-carousel .carousel-control-prev,
#tvmedia-rating-carousel .carousel-control-next {
    display: none !important;
}
/* Prevent pointer events on entire carousel */
#tvmedia-rating-carousel .carousel-inner {
    pointer-events: none;
}
/* But ENABLE pointer events only for the stars and skip button */
.rating-stars, .skip-item-btn {
    pointer-events: auto !important;
}
/* Make titles and genres not look like controls */
.card-title, h5, .card-title *, h5 * {
    user-select: text;
    cursor: default !important;
}
</style>

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8">
            <div class="card shadow-lg animate__animated animate__fadeInUp">
                <div class="card-body px-4">

                    <h2 class="card-title mb-3 text-center animate__animated animate__zoomIn" style="pointer-events:none;">
                        <span style="display:inline-block;vertical-align:middle;animation:bounce 2s infinite;pointer-events:none;">
                            <i class="bi bi-star-fill text-warning"></i>
                        </span>
                        <span style="pointer-events: none;">Rate TV Media</span>
                    </h2>
                    <hr>
                    {% if object_list %}
                    <div id="tvmedia-rating-carousel" class="carousel slide" data-bs-interval="false">
                        <div class="carousel-inner">

                            {% for object in object_list %}
                            <div class="carousel-item {% if forloop.first %}active{% endif %} fade-in" data-tvmedia-id="{{ object.id|escapejs }}">
                                <div class="mb-4 pb-3">
                                    <h5 class="mb-1 animate__animated animate__fadeInDown" style="pointer-events:none;">
                                        {{ object.original_title }}
                                    </h5>

                                    {% if object.startyear %}
                                        <div class="mb-1 text-muted animate__animated animate__fadeInLeft" style="pointer-events:none;">
                                            Year: <span class="fw-semibold">{{ object.startyear }}</span>
                                        </div>
                                    {% endif %}

                                    {% if object.genre.all %}
                                        <div class="animate__animated animate__fadeInLeft animate__delay-1s" style="pointer-events:none;">Genres:
                                            {% for g in object.genre.all %}
                                                <span class="badge rounded-pill bg-secondary me-1 animate__animated animate__pulse">{{ g.name }}</span>
                                            {% endfor %}
                                        </div>
                                    {% endif %}

                                    <form class="tvmedia-rating-form" data-item-index="{{ forloop.counter0 }}" data-tvmedia-id="{{ object.id|escapejs }}"
                                          method="post" action="{% url 'tvmedia-rate' %}">
                                        {% csrf_token %}
                                        <input type="hidden" name="tvmedia" value="{{ object.id }}">
                                        <div class="mb-2 mt-3">
                                            <label class="form-label" id="rating-label-{{ object.id }}" style="pointer-events:none;">
                                                <strong>
                                                {% if rated_dict.object.id %}
                                                    Your rating:
                                                {% else %}
                                                    Your rating (1-10):
                                                {% endif %}
                                                </strong>
                                            </label>
                                            <br>
                                            <div class="rating-stars" data-tvmedia="{{ object.id }}">
                                                {% for n in rating_numbers %}
                                                    <input type="radio"
                                                        id="star-{{ n }}-{{ object.id }}"
                                                        name="rating"
                                                        value="{{ n }}"
                                                        {% if current_ratings.object.id == n|stringformat:"s" %}checked{% endif %}
                                                        {% if rated_dict.object.id %}disabled{% endif %}
                                                    >
                                                    <label for="star-{{ n }}-{{ object.id }}" title="{{ n }}">
                                                        <i class="bi bi-star-fill"></i>
                                                    </label>
                                                {% endfor %}
                                            </div>

                                            {% if rated_dict.object.id %}
                                                <span class="badge bg-success ms-2 align-middle">Already rated</span>
                                            {% endif %}
                                        </div>
                                        <div class="rating-feedback mt-2" style="min-height:22px;"></div>
                                    </form>
                                    <button type="button" class="btn btn-secondary skip-item-btn mt-3" tabindex="0">
                                        Skip
                                    </button>
                                </div>
                            </div>
                            {% endfor %}

                        </div>
                        {# Carousel controls are hidden using CSS #}
                    </div>
                    {% else %}
                        <div class="alert alert-info text-center mb-0 animate__animated animate__fadeIn">
                            <i class="bi bi-info-circle me-1"></i> No TV media available for rating.
                        </div>
                    {% endif %}

                </div>

                <div class="text-center mt-5 pb-4">
                    <a href="{% url 'tvmedia-rec-page' %}" class="btn btn-outline-primary btn-lg animate__animated animate__pulse animate__infinite">
                        <i class="bi bi-stars"></i> Check Recommendations
                    </a>
                </div>

            </div>
        </div>
    </div>
</div>
<!-- Bootstrap Icons CDN for star icons, if not already globally present -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"></script>
<script>
/*
Custom logic to ensure:
- After rating an item, that item is removed from the DOM entirely (from carousel).
- No accidental "old" form submission.
- When all are gone, auto reload the page.
- Only stars and skip buttons are interactive.
*/

// Prevent all click/keypress on carousel except rating stars and skip
document.addEventListener('DOMContentLoaded', function () {
    var carouselElement = document.getElementById('tvmedia-rating-carousel');
    var carouselInstance = carouselElement ? bootstrap.Carousel.getOrCreateInstance(carouselElement) : null;

    // Remove event handlers for default Bootstrap carousel controls
    if (carouselElement) {
        // Hide controls in markup too, just in case
        let prevBtn = carouselElement.querySelector('.carousel-control-prev');
        let nextBtn = carouselElement.querySelector('.carousel-control-next');
        if (prevBtn) prevBtn.remove();
        if (nextBtn) nextBtn.remove();
    }

    // Disable pointer events on everything except .rating-stars and .skip-item-btn (done in CSS above)

    // Setup rating stars and form handlers
    function attachStarListeners() {
        document.querySelectorAll('.rating-stars').forEach(function(wrapper){
            let stars = wrapper.querySelectorAll('input[type="radio"]');
            let labels = wrapper.querySelectorAll('label');
            stars.forEach(function(input){
                input.addEventListener('focus', function(){
                    wrapper.classList.add('focus');
                });
                input.addEventListener('blur', function(){
                    wrapper.classList.remove('focus');
                });
                input.addEventListener('change', function(){
                    labels.forEach(label=>label.classList.add('animate__animated','animate__pulse'));
                    setTimeout(function(){
                        labels.forEach(label=>label.classList.remove('animate__animated','animate__pulse'));
                    }, 250);

                    var form = input.closest('form');
                    if(form && !form.querySelector('.badge.bg-success') && !input.disabled) {
                        submitTvmediaRating(form, input.value);
                    }
                });
            });
            labels.forEach(function(label){
                label.addEventListener('mouseenter', function(){
                    label.classList.add('animate__animated','animate__jello');
                });
                label.addEventListener('mouseleave', function(){
                    label.classList.remove('animate__animated','animate__jello');
                });
            });
        });
    }
    attachStarListeners();

    function countCarouselItems() {
        if (!carouselElement) return 0;
        return carouselElement.querySelectorAll('.carousel-item').length;
    }

    // Remove carousel item safely
    function removeCarouselItem(item) {
        var wasActive = item.classList.contains('active');
        var parentCarousel = item.closest('.carousel');
        var allItems = Array.from(parentCarousel.querySelectorAll('.carousel-item'));
        var idx = allItems.indexOf(item);

        // Remove from DOM
        item.parentElement.removeChild(item);

        // If that item was active, activate the nearest remaining (next or prev)
        var remainingItems = parentCarousel.querySelectorAll('.carousel-item');
        if (remainingItems.length > 0) {
            // If removed the last, activate previous, else next
            var activateIdx = Math.min(idx, remainingItems.length-1);
            remainingItems.forEach(ci => ci.classList.remove('active'));
            remainingItems[activateIdx].classList.add('active');
        }
    }

    function showSiteMessage(type, message) {
        let container = document.getElementById('site-message-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'site-message-container';
            container.style.position = 'fixed';
            container.style.top = '70px';
            container.style.left = '50%';
            container.style.zIndex = '2000';
            container.style.transform = 'translateX(-50%)';
            container.style.minWidth = '250px';
            document.body.appendChild(container);
        }
        container.innerHTML = '';
        let alert = document.createElement('div');
        alert.className = 'alert alert-' + (type || 'danger') + ' alert-dismissible fade show shadow';
        alert.role = 'alert';
        alert.innerHTML = message + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
        container.appendChild(alert);
        setTimeout(function() {
            if (container.contains(alert)) alert.classList.remove('show');
        }, 6000);
    }

    function submitTvmediaRating(form, selectedRating) {
        if(form.classList.contains('submitted')) return;
        form.classList.add('submitted');

        var formData = new FormData(form);
        formData.set('rating', selectedRating);

        var feedbackDiv = form.querySelector(".rating-feedback");
        if (feedbackDiv) { feedbackDiv.innerHTML = ""; }

        let starsRadio = form.querySelectorAll('.rating-stars input[type="radio"]');
        starsRadio.forEach(function(r){ r.disabled = true; });

        fetch(form.action, {
            method: "POST",
            body: formData,
            headers: { "X-Requested-With": "XMLHttpRequest" },
            credentials: 'same-origin'
        }).then(async function(response) {
            let data;
            let textData = "";
            try {
                const respClone = response.clone();
                try { data = await response.json(); } catch { data = {}; }
                try { textData = await respClone.text(); } catch { textData = ""; }
            } catch {data={}; textData="";}
            if ((response.status === 201) || (response.ok && (data && data.data))) {
                // Success!
                let badge = form.querySelector('.badge.bg-success');
                if(!badge) {
                    let badgeNode = document.createElement('span');
                    badgeNode.className = "badge bg-success ms-2 align-middle animate__animated animate__tada animate__fast";
                    badgeNode.textContent = "Already rated";
                    let starWrap = form.querySelector('.rating-stars');
                    if(starWrap) starWrap.parentElement.appendChild(badgeNode);
                }
                if(feedbackDiv) {
                    feedbackDiv.innerHTML =
                        `<span class="text-success animate__animated animate__fadeIn animate__faster">
                            <i class="bi bi-star-fill"></i> Thank you for rating!
                        </span>`;
                }

                // REMOVE carousel-item from DOM, then proceed
                setTimeout(function() {
                    var item = form.closest('.carousel-item');
                    if (item) {
                        item.classList.add('fade-out-right');
                        setTimeout(function() {
                            removeCarouselItem(item);

                            // Check if any left
                            var left = countCarouselItems();
                            if (left === 0) {
                                // All items rated - show site message & reload
                                showSiteMessage('info', '<i class="bi bi-check2-circle"></i> All media rated! Reloading...');
                                setTimeout(function(){ window.location.reload(); }, 1300);
                            } else {
                                // Small fade-in animation to next
                                var activeItem = carouselElement.querySelector('.carousel-item.active');
                                if(activeItem) {
                                    activeItem.classList.add('fade-in');
                                    setTimeout(function() {
                                        activeItem.classList.remove('fade-in');
                                    }, 700);
                                }
                            }
                        }, 500);
                    }
                }, 700);

            } else {
                // Error
                starsRadio.forEach(function(r){ r.disabled = false; });
                form.classList.remove('submitted');
                let errorMsg = "Error submitting rating.";
                if (data && data.detail) {
                    errorMsg = data.detail;
                } else if (data && data.rating && typeof data.rating[0] === "string") {
                    errorMsg = data.rating[0];
                } else if (data && data.tvmedia && typeof data.tvmedia[0] === "string") {
                    errorMsg = data.tvmedia[0];
                } else if (data && typeof data === "object" && Object.keys(data).length > 0) {
                    let allErrs = [];
                    for (const k in data) {
                        if(Array.isArray(data[k])) {
                            allErrs.push(...data[k]);
                        } else if(typeof data[k] === "string") {
                            allErrs.push(data[k]);
                        }
                    }
                    if (allErrs.length > 0) {
                        errorMsg = allErrs.join(", ");
                    }
                } else if (textData) {
                    let cleaned = textData.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    errorMsg = cleaned.slice(0,200);
                }
                if(feedbackDiv) {
                    feedbackDiv.innerHTML ="<span class='text-danger animate__animated animate__shakeX'><i class='bi bi-x-circle-fill'></i> " + errorMsg + "</span>";
                }
                showSiteMessage('danger', "<i class='bi bi-x-circle-fill'></i> " + errorMsg);

                form.classList.add('animate__animated','animate__shakeX');
                setTimeout(function(){
                    form.classList.remove('animate__animated','animate__shakeX');
                },400);
            }
        }).catch(function(error) {
            starsRadio.forEach(function(r){ r.disabled = false; });
            form.classList.remove('submitted');
            let errMsg = "Error submitting rating.";
            if (error && error.message) {
                errMsg = error.message;
            }
            if(feedbackDiv) {
                feedbackDiv.innerHTML ="<span class='text-danger animate__animated animate__shakeX'><i class='bi bi-x-circle-fill'></i> " + errMsg + "</span>";
            }
            showSiteMessage('danger', "<i class='bi bi-x-circle-fill'></i> " + errMsg);
            form.classList.add('animate__animated','animate__shakeX');
            setTimeout(function(){
                form.classList.remove('animate__animated','animate__shakeX');
            },400);
        });
    }

    // JS safety - Remove default submit behavior
    document.querySelectorAll('.submit-rating-btn').forEach(btn => btn.remove());
    document.querySelectorAll('.tvmedia-rating-form').forEach(function(form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
        });
    });

    // Skip functionality
    document.querySelectorAll('.skip-item-btn').forEach(function(btn){
        btn.addEventListener('click', function(e){
            let item = btn.closest('.carousel-item');
            if (item) {
                item.classList.add('fade-out-right');
                setTimeout(function() {
                    removeCarouselItem(item);

                    // Check if any left
                    var left = countCarouselItems();
                    if (left === 0) {
                        showSiteMessage('info', '<i class="bi bi-check2-circle"></i> No more media. Reloading...');
                        setTimeout(function(){ window.location.reload(); }, 1300);
                    } else {
                        // Animate in next item
                        var activeItem = carouselElement.querySelector('.carousel-item.active');
                        if(activeItem) {
                            activeItem.classList.add('fade-in');
                            setTimeout(function() {
                                activeItem.classList.remove('fade-in');
                            }, 700);
                        }
                    }
                }, 700);
            }
        });
    });

    // Prevent keydown events except on skip button and star inputs
    if (carouselElement) {
        carouselElement.addEventListener('keydown', function(e) {
            let active = document.activeElement;
            // allow keys only on stars and skip button
            if (
                !(
                    active &&
                    (
                        (active.classList && active.classList.contains('skip-item-btn')) ||
                        (active.type === 'radio' && active.name === 'rating')
                    )
                )
            ) {
                e.preventDefault();
                return false;
            }
        }, true);
    }
});
</script>

<div id="site-message-container" style="position:fixed;top:70px;left:50%;transform:translateX(-50%);z-index:2000;min-width:250px;max-width:560px;width:auto;"></div>

{% endblock %}
